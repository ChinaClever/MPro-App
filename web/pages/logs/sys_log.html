<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="ie=edge,chrome=1">
		<meta name="renderer" content="webkit">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>logs</title>
		<link rel="stylesheet" href="../../include/css/public.min.css">
		<link rel="stylesheet" href="../../include/css/iconfont.min.css">
		<link rel="stylesheet" href="../../include/css/font-awesome.min.css">
		<link rel="stylesheet" href="../doc-lib/solarized-light.css">
		<link rel="stylesheet" href="../doc-lib/doc.css">
	</head>
<body>
	<div class="page-cont">
		<div class="section">
			<div class="section-cont">
				<div class="grid-row">
					<div class="grid-col grid-col-7">
						<div class = "panel panel-default">
							<div class ="panel-heading">
								<i class = "fa fa-th-list fa-lg " style="padding-right:5px;"></i>
								<span id="lang_2">系统日志</span>
							</div>
						</div>
					</div>
					<div class="grid-col grid-col-7">
						<table class="table table-striped text-center"></table>
					</div>
					<div>
						<br/>
						<span style = "float:right;"><span style = "margin: 5px;" >日志大小：</span><span style = "margin: 5px;" id  ="log_size"></span><span style = "margin: 5px;">页<input id = "page" style = "width:3%;text-align: center;" value="0">/页<span id  ="page_num"></span></span><span>
							<input type ="button" style = "width:11%" id  = "jump" value="前往"  onclick="setData(this)">
							<input type ="button" style = "width:11%" id  = "last" value="上一页"  onclick="setData(this)">
							<input type ="button" style = "width:11%" id  = "next" value="下一页"  onclick="setData(this)">
							<input type ="button" style = "width:11%" id  = "del" value="删除日志"  onclick="setData(this)">
							<input type ="button" style = "width:11%" id  = "export" value="导出" onclick="saveArrayDataToExcel()">
						</span>
					</div>
				</div>
			</div>
		</div>

    <script src="../../include/js/jquery-1.11.3.min.js"></script>
	<script src="../../include/js/rpc-over-websocket.js"></script>
    <script src="../../include/js/public.min.js"></script>
	<script src="../doc-lib/highlight.pack.js"></script>
	<script src="../doc-lib/doc.js"></script>
    <script>
		let log_data = new Array();
		let log_num = 0,page_num = 1,page_size = 0;
		let show_num = 0;
		read_log_data(3,1,0,0);
		function read_data(){
			let stat = 0;
			let log_str = window.JSON.parse(sessionStorage.getItem(log_info[2]));
			if(show_num < 20){
				stat = 0;
			}else{
				stat = log_num - (page_num)*20 -1 ;
			}
			for(var i = 0 ;i < show_num;i++)
			{
				log_data[i]= new Array();
				for(let j = 0;j < 3;j++){
					if(show_num < 20){
						log_data[i][j] = log_str.logs[stat+ (show_num - i - 1)][j];
					}else{
						log_data[i][j] = log_str.logs[stat+ (show_num - i)][j];
					}
				}
			}
		}
		setTimeout(function(){
			let stat = 0;
			log_num = parseInt(sessionStorage.getItem(log_info[1]));
			if(log_num > 20){
				show_num = 20;
				stat = (log_num-20);
			}else{
				show_num = log_num;
				stat= 0;
			}
			read_log_data(3,2,stat,show_num);
		},300);
		setTimeout(function(){
			read_data();
			$('.table-striped').html(buildTable(show_num));
			showdata();
		},600);
		function flash_html(par)
		{
			setTimeout(function(){
				par.parentNode.parentNode.parentNode.parentNode.childNodes[3].childNodes[1].childNodes[1].remove();
				read_data();
				$('.table-striped').html(buildTable(show_num));
				showdata();
			},800);
		}
		function showdata(){
			if(log_num % 20 == 0){
				page_size = parseInt(log_num/20);
			}else{
				page_size = parseInt(log_num/20) + 1;
			}
			let size = document.getElementById("log_size");
			let p = document.getElementById("page");
			let p_n = document.getElementById("page_num");
			size.innerHTML = log_num+"条";
			p.value = page_num;
			p_n.innerHTML = page_size;

		}
		function saveArrayDataToExcel() {
			var retVal = confirm("请确认是否导出此表单！");
			if(retVal == true)
			{
				let str = "序号,时间,用户名称,操作类型,详细描述\n";
				for(let i = 0;i < show_num;i++){
					str+=(i+1)+',';
					for(let j = 0;j < 4;j++){
						if(j == 1){
							str+= user_name+',';
						}else if(j>1){
							str+=log_data[i][j-1]+',';
						}else{
							str+=log_data[i][j]+',';
						}
					}
					str += '\n';
				}
				// encodeURIComponent解决中文乱码
				const uri = 'data:text/csv;charset=utf-8,\ufeff' + encodeURIComponent(str);
				// 通过创建a标签实现
				const link = document.createElement("a");
				link.href = uri;
				// 对下载的文件命名
				link.download =  "sys_log_"+ page_num +".csv";
				link.click();
			}else{}
    	}
		function setData(btn){
			let stat = 0;
			var retVal = confirm("请确认是否执行此操作！");
			if(retVal == true)
			{
				if(btn.id == "jump"){
					let p = parseInt(document.getElementById("page").value);
					if(p == page_num || p > page_size){

					}else{
						page_num = p;
						if(page_num * 20 > log_num){
							show_num = log_num - ((page_num - 1) * 20);
							stat = 0;
						}else{
							show_num = 20;
							stat = (log_num-(page_num * 20));
						}
						read_log_data(3,2,stat,show_num);
						flash_html(btn);
					}
				}else if(btn.id == "last"){ 
					if((page_num - 1) > 0){
						page_num -= 1;
						show_num = 20;
						read_log_data(3,2,(log_num-(page_num * 20)),show_num);
						flash_html(btn);
					}else{

					}
				}else if(btn.id == "next"){
					if((page_num + 1) <= page_size){
						page_num += 1;
						if(page_num * 20 > log_num){
							show_num = log_num - ((page_num - 1) * 20);
							stat = 0;
						}else{
							show_num = 20;
							stat = (log_num-(page_num * 20));
						}
						read_log_data(3,2,stat,show_num);
						flash_html(btn);
					}else{
						//read_log_data(3,3,0,0);
						flash_html(btn);
					}
				}else{

				}
			}else{}
		}
		function buildTable(rows) {
			var thead = '',
				tbody = '';

			for (var i = 0; i < rows; i++) {
				if (i === 0) {
					thead = '<tr><td width ="6%">序号</td>\
					<td width ="26%">时间</td>\
					<td width ="12%">用户名称</td>\
					<td width ="12%">系统类型</td>\
					<td width ="40%">详细描述</td>';
				}
				tbody += '<tr id = "tr'+ i + '">';
				tbody += '<td id = "a'+ i + '">' + ((page_num - 1)*20+(i+1)) + '</td>';
				tbody += '<td id = "b'+ i + '">'+ log_data[i][0] +'</td>';
				tbody += '<td id = "c'+ i + '">'+ user_name +'</td>';
				tbody += '<td id = "d'+ i + '">'+ log_data[i][1] +'</td>';
				tbody += '<td id = "d'+ i + '">'+ log_data[i][2] +'</td>';
				tbody += '</tr>';
			}

			return '<thead>' + thead + '</thead>'
				 + '<tbody>' + tbody + '</tbody>';
		}
    </script>
</body>
</html>
