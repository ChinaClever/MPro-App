<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="ie=edge,chrome=1">
		<meta name="renderer" content="webkit">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>chart</title>
		<link rel="stylesheet" href="../../include/css/public.min.css">
		<link rel="stylesheet" href="../../include/css/index.min.css">
		<link rel="stylesheet" href="../../include/css/iconfont.min.css">
		<link rel="stylesheet" href="../../include/css/font-awesome.min.css">
		<link rel="stylesheet" href="../../doc-lib/solarized-light.css">
		<link rel="stylesheet" href="../../doc-lib/doc.css">

		<script src="../../include/js/jquery-1.11.3.min.js"></script>
		<script src="../../include/js/rpc-over-websocket.js"></script>
		<script src="../../include/js/public.min.js"></script>
		<script src="../../include/js/fn_public.js"></script>
		<script src="../../doc-lib/highlight.pack.js"></script>
		<script src="../../doc-lib/doc.js"></script>
		<script src="../../include/js/chart.min.js"></script>
		<style>
			.box{
				border: 1px solid #C4C2C3;
				background-color: #fff;
			}
			tr{
				height: 30px;
			}
		</style>
	</head>
<body>
	<div style="padding: 0px; margin-bottom: 0.8%; overflow: hidden; ">
		<div class="box" style="width: 100%; margin-bottom: 0.8%;  background:#e7e7e7;">
			<div align="center" style="border:0px solid;border-color: #aaaaff; margin:0px 10px 10px 10px; height:550px; background:#ffffff;">
				<div style="text-align:left; padding-left:20px; padding-top:8px; height:40px; border-bottom:#e1dfdf 2px solid;" id="lang_1"></div>
					<br/>
					<div align="center">
						<span><span id ="lang_2"></span><span></span><select class ="devname" id ="dev" style ="width:8%;" onchange = "change(this);"></select></span>
						<span style="padding-left: 1%;" id ="lang_3"></span><span><select class ="typename" id ="type" style ="width:8%;" onchange = "change(this);"></select></span>
						<span style="padding-left: 1%;" id ="lang_4"></span><span><select class ="topicname" id ="topic" style ="width:4%;" onchange = "change(this);"></select></span>
						<span style="padding-left: 1%;" id ="lang_5"></span><span><select class ="num" id ="num" style ="width:4%;" onchange = "change(this);"></select></span>
						<span style="padding-left: 1%;" id ="lang_6"></span><span><input  type = "date"  id = "start_date"></span>
						<span> - </span><span><input  type = "date"  id = "end_date"></span>
						<span style="padding-left: 3%;"></span><input type ="button" style = "width:6%;" id  = "submit" value="submit"  onclick="getData()">
						</span>
						<br/><br/>
					</div>
					<div  id="container" style="width:90%; height:500px;">
						<canvas id="chart" style="display: block; width: 90%; height: 410px;"></canvas>
					</div>
					<script type="text/javascript">
						let log_data = new Array();
						let dev_name_ = new Array();
						let type_name_ = new Array();
						let topic_name_ = new Array();
						let num_name_ = new Array();
						let lang = new Array();
						let language = 1;
						let get_arr = new Array("dev","type","topic","num","start_date","end_date");
						let phase_num = parseInt(sessionStorage.getItem("PhaseNum" + addr));
						let slave_num = parseInt(sessionStorage.getItem("SlaveNum" + addr)) +1 ;
						let output_num = parseInt(sessionStorage.getItem("OutputNum" + addr));
						let loop_num = parseInt(sessionStorage.getItem("LoopNum" + addr));
						let num_type = 6;
						let dataLabels = new Array();
						let data_total = new Array();
						lang_init();
						datetime();
						function lang_init(){
							let i = 0;
							for(i = 1;i<41;i++){
								lang[i] = new Array();
							}
							lang[1] = ["","系统日志","","","",""];
							lang[2] = ["","设备选择:","","","",""];
							lang[3] = ["","数据选择:","","","",""];
							lang[4] = ["","数据类型:","","","",""];
							lang[5] = ["","相/回路/输出位:","","","",""];
							lang[6] = ["","起止日期:","","","",""];
							lang[7] = ["","主机","","","",""];
							lang[8] = ["","副机","","","",""];
							lang[9] = ["","相数据","","","",""];
							lang[10] = ["","回路数据","","","",""];
							lang[11] = ["","输出位数据","","","",""];
							lang[12] = ["","组数据","","","",""];
							lang[13] = ["","双电源数据","","","",""];
							lang[14] = ["","温湿度数据","","","",""];
							lang[15] = ["","电压","","","",""];
							lang[16] = ["","电流","","","",""];
							lang[17] = ["","功率","","","",""];
							lang[18] = ["","电能","","","",""];
							lang[19] = ["","温度","","","",""];
							lang[20] = ["","湿度","","","",""];
							lang[21] = ["","提交","","","",""];
							for(i = 0;i<slave_num;i++){
								if(i == 0){
									dev_name_[i] = lang[7][language];
								}else{
									dev_name_[i] = lang[8][language] + i;
								}
							}
							for(i = 0;i<num_type;i++){
								type_name_[i] = lang[9 + i][language];
								num_name_[i] = new Array();
							}
							topic_name_[0] = new Array(lang[15][language],lang[16][language],lang[17][language],lang[18][language]);
							topic_name_[1] = new Array(lang[19][language],lang[20][language]);
							for(i = 0;i<phase_num;i++){
								num_name_[0][i] = i+1;
							}
							for(i = 0;i<loop_num;i++){
								num_name_[1][i] = i+1;
							}
							for(i = 0;i<output_num;i++){
								num_name_[2][i] = i+1;
							}
							for(i = 0;i<group_num;i++){
								num_name_[3][i] = i+1;
							}
							for(i = 0;i<output_num;i++){
								num_name_[4][i] = i+1;
							}
							for(i = 0;i<2;i++){
								num_name_[5][i] = i+1;
							}
						}
						function buildSel(opt,rows,name)
						{
							var tbody = '';
							for(var i = 0;i<rows;i++)
							{
								tbody += '<option id = "'+opt+ i + '"value ="'+ i +'">'+name[i]+'</option>';
							}
							return tbody;
						}
						function lang_fun(){
							let i = 0;
							for(i = 1;i<7;i++){
								document.getElementById("lang_" + i).innerHTML  = lang[i][language];
							}
						}
						function change(sel){
							let i = parseInt(sel.value);
							if(sel.id == get_arr[1]){
								if(i < 5){
									$('.topicname').html(buildSel("topic",topic_name_[0].length,topic_name_[0]));
									$('.num').html(buildSel("num",num_name_[i].length,num_name_[i]));
								}else{
									$('.topicname').html(buildSel("topic",topic_name_[1].length,topic_name_[1]));
									$('.num').html(buildSel("num",num_name_[i].length,num_name_[i]));
								}
							}
						}
						function getData(){
							let arr = new Array();
							if(confirm("请确认是否执行此操作！")){
								for(let i = 0;i<get_arr.length;i++){
									if(i<4){
										arr[i] = parseInt(document.getElementById(get_arr[i]).value);
									}else{
										arr[i] = document.getElementById(get_arr[i]).value;
									}
								}
								if(arr[1]<5){
									arr[2] += 2;
								}else{
									arr[2] += 10;
								}
								arr[3] += 1;
								arr[1] += 1;
								sessionStorage.setItem("LogData" , "");
								rpc.call('pduLogHda',[arr[0],82,arr[1]+';'+arr[2]+';'+arr[3]+';',arr[4],arr[5]]);
								read_data();
							}else{}
						}
						function read_data(){
							let time1 = setInterval(function(){
								log_str = window.JSON.parse(sessionStorage.getItem("LogData"));
								if(log_str != ""){
									clearInterval(time1);
									log_num = getJsonLength(log_str.logs);
									for(let i = 0;i<log_num;i++){
										dataLabels[i] = log_str.logs[i][0];
										data_total[i] = parseFloat(log_str.logs[i][5]).toFixed(1);
									}
									create_new_chart();
									config.data.datasets.label = total_name;
									config.data.datasets.data = data_total;
									chart.update();
								}
							},1000);
						}
						function datetime(){
							var today = new Date();
							var yyyy = today.getFullYear();
							var MM = today.getMonth() + 1;
							var dd = today.getDate();
							MM = checkTime(MM);
							dd = checkTime(dd);
							let date_ = yyyy + "-" + MM+ "-" + dd;
							document.getElementById("start_date").value = date_;
							document.getElementById("end_date").value = date_;
						}
						function checkTime(i) {
							if (i < 10) {
								i = "0" + i;
							}
							return i;
						}
						function getJsonLength(jsonData){
							var jsonLength = 0;
							for(var item in jsonData){
							jsonLength++;
							}
							return jsonLength;
						}
						lang_fun();
						$('.devname').html(buildSel("dev",slave_num,dev_name_));
						$('.typename').html(buildSel("type",num_type,type_name_));
						$('.topicname').html(buildSel("topic",topic_name_[0].length,topic_name_[0]));
						$('.num').html(buildSel("num",num_name_[0].length,num_name_[0]));

						let config = {
							type: 'line',
							data: {
								labels: dataLabels,
								datasets: [
									{
										label: 'inletC',
										data: data_total,
										backgroundColor: 'rgb(70, 130, 180)',
										borderColor: 'rgb(70, 130, 180)',
										fill: false,
										borderWidth:1.5,
										pointRadius: 2,
									}
								]
							},
							options: {
								responsive: true,
								title: {
									display: true,
									text: '功率信息实时统计'
								},
								scales: {
									xAxes: [{
										ticks: {
											min: 50,
										}
									}]
  							  	}
							}
						};
						function create_new_chart(){
							document.getElementById('chart').remove();
							document.getElementsByClassName('chartjs-size-monitor')[0].remove();		
							let e = document.createElement("canvas"); 
							e.id = "chart";
							e.style.display = "block";
							e.style.width = "90%";
							e.style.height = "410px";
							document.getElementById('container').appendChild(e);

							ctx = document.getElementById('chart').getContext('2d');
							chart = new Chart(ctx, config);
						}
						function change_mode(obj){
							chart_type =parseInt(obj.value);
							clearInterval(time1);
							if(obj.value == 0){
								total_name = "total_pow";
							}else if(obj.value == 1){
								total_name ="total_cur";
							}else{
								total_name ="total_vol";
							}
							create_new_chart();
							set_data_show(chart_type);
							config.data.datasets[0].label = total_name;
							config.data.datasets[0].data = data_total;
							config.data.datasets[1].data = data_inlet1;
							config.data.datasets[2].data = data_inlet2;
							config.data.datasets[3].data = data_inlet3;
							chart.update();
						}
						function flash_chart() {
							if (config.data.datasets.length > 0) {
								dataLabels.push(dataLabels);
								data_total.push(data_total);
								// total_name.push(total_name);
				
								dataLabels.shift();
								data_total.shift();
								// total_name.shift();

								chart.update();
							}
						}
						ctx = document.getElementById('chart').getContext('2d');
						chart = new Chart(ctx, config);
				
					</script>
				</div>
			</div>
		</div>
	</div>
    <script>
    </script>
</body>
</html>
