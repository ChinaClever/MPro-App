/*
 *                        _oo0oo_
 *                       o8888888o
 *                       88" . "88
 *                       (| -_- |)
 *                       0\  =  /0
 *                     ___/`---'\___
 *                   .' \\|     |// '.
 *                  / \\|||  :  |||// \
 *                 / _||||| -:- |||||- \
 *                |   | \\\  - /// |   |
 *                | \_|  ''\---/''  |_/ |
 *                \  .-\__  '-'  ___/-. /
 *              ___'. .'  /--.--\  `. .'___
 *           ."" '<  `.___\_<|>_/___.' >' "".
 *          | | :  `- \`.;`\ _ /`;.`/ - ` : | |
 *          \  \ `_.   \_ __\ /__ _/   .-` /  /
 *      =====`-.____`.___ \_____/___.-`___.-'=====
 *                        `=---='
 * 
 * 
 *      ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 * 
 *            佛祖保佑     永不宕机     永无BUG
 * 
 * 
 *        佛曰:  
 *                写字楼里写字间，写字间里程序员；  
 *                程序人员写程序，又拿程序换酒钱。  
 *                酒醒只在网上坐，酒醉还来网下眠；  
 *                酒醉酒醒日复日，网上网下年复年。  
 *                但愿老死电脑间，不愿鞠躬老板前；  
 *                奔驰宝马贵者趣，公交自行程序员。  
 *                别人笑我忒疯癫，我笑自己命太贱；  
 *                不见满街漂亮妹，哪个归得程序员？
 *
 * 
 *  
 *                    江城子 . 程序员之歌
 * 
 *               十年生死两茫茫，写程序，到天亮。
 *                   千行代码，Bug何处藏。
 *               纵使上线又怎样，朝令改，夕断肠。
 * 
 *               领导每天新想法，天天改，日日忙。
 *                   相顾无言，惟有泪千行。
 *               每晚灯火阑珊处，夜难寐，加班狂。
 * 
 *
 *
 *  Created on: 2023年2月1日
 *      Author: Lzy
 */



class JsonRpc{static _errCnt=0;static _instance=null;constructor(){this.rpcid=0,this.timeOut=65,this.isSetting=!1,this.uuid=btoa(window.location.host),this.root_map=this.rpc_map(),this.ws=this.socket_open(),this.cnt=0}static build(){return JsonRpc._instance||(JsonRpc._instance=new JsonRpc),JsonRpc._instance}rpc_map(){var t=new Map,s=window.sessionStorage,e=s.getItem(btoa("root_map"));if(null!=e){let s=JSON.parse(e),r=Object.entries(s);t=new Map(r)}return null!=(e=s.getItem(btoa("uuid")))&&(this.uuid=e),t}rpc_uid(){return this.uuid}rpc_url(){var t="ws",s=window.location.host;return"https:"==window.location.protocol&&(t="wss",this.timeOut=210),t+"://"+s+"/websocket"}getRootMap(){return this.root_map}getTimeOut(){return this.timeOut}clear(){this.root_map.clear()}static socket_close(t){JsonRpc._errCnt++>10&&alert("json rpc websocket close")}static socket_error(t){JsonRpc._errCnt++>10&&alert("json rpc websocket error")}socket_open(){var t=this.rpc_url(),s=new WebSocket(t);return JsonRpc._errCnt=0,s.onmessage=function(t){JsonRpc.socket_recv(t)},s.onopen=function(){JsonRpc.socket_req()},s}static socket_reqSend(t,s){var e=JsonRpc.build(),r=e.getRootMap(),o=s[0]+"_"+s[1]+"_"+s[2]+"_"+s[3]+"_"+s[4];r.has(o)||e.json_rpc_get(t,s)}static socket_req(){var t="pduMetaData",s=[0,100,0,0,0];JsonRpc.build().json_rpc_get(t,s),t="pduReadParam",s=[0,13,18,0,0],JsonRpc.socket_reqSend(t,s),s=[0,13,10,0,0],JsonRpc.socket_reqSend(t,s),s=[0,42,3,0,0],JsonRpc.socket_reqSend(t,s),s=[0,14,1,0,0],JsonRpc.socket_reqSend(t,s),s=[0,14,3,0,0],JsonRpc.socket_reqSend(t,s)}socket_send(t){var s=!0;return this.ws.readyState<=WebSocket.OPEN?0==this.ws.readyState||this.ws.send(t):JsonRpc._errCnt++>2&&(s=!1,this.ws.close(),this.ws=this.socket_open()),s}static socket_recv(t){var s=JSON.parse(t.data).result;s&&JsonRpc.build().json_rpc_recv(s)}json_rpc_recv(t){var s=t[0],e=t[1],r=t[2],o=t[3],i=t[4],a=t[5];if(-1==parseInt(a)){var n=btoa(window.location.host);window.sessionStorage.setItem(btoa("uuid"),n);var g=window.location.protocol+"//";g+=window.location.host,this.ws.close(),window.location.replace(g)}var c=window.sessionStorage;if(14==parseInt(e)&&11==parseInt(r)&&1==parseInt(a[0])){var u=window.location.host;c.setItem(btoa("host"),u),this.uuid=a.slice(3),a=1,c.setItem(btoa("uuid"),this.uuid)}0==s&&13==e&&10==r&&(c.setItem("language",a),this.cnt=0),0==s&&13==e&&18==r&&(c.setItem("bg_color",a),this.cnt=0);var d=s+"_"+e+"_"+r+"_"+o+"_"+i;if(this.root_map.set(d,a),this.cnt+=1,this.cnt%5==1||this.cnt<15){const t=Object.fromEntries(this.root_map);c.setItem(btoa("root_map"),JSON.stringify(t))}return!0}json_rpc_obj(t,s){const e={id:this.rpcid++,method:t,params:s};var r=JSON.stringify(e);return this.socket_send(r)}json_rpc_get(t,s){return this.isSetting=!1,s.push(0),s.push(this.uuid),this.json_rpc_obj(t,s)}chineseToBase64(t){const s=unescape(encodeURIComponent(t));return btoa(s)}json_rpc_login(t){var s=t[0],e=t[1],r=t[2],o=t[3],i=t[4];if(14==e&&11==r){var a=s+"_"+e+"_"+r+"_"+o+"_"+i;this.root_map.set(a,255);const t=Object.fromEntries(this.root_map);sessionStorage.setItem(btoa("root_map"),JSON.stringify(t))}}json_rpc_set(t,s){return this.isSetting=!0,s.push(this.uuid),this.json_rpc_login(s),this.json_rpc_obj(t,s)}json_rpc_value(t){var s=null;return this.root_map.has(t)&&(s=this.root_map.get(t)),s}}class PduMetaData{static m_addr=0;constructor(){this.rpc=JsonRpc.build(),this.addr=PduMetaData.m_addr,setTimeout((function(){PduMetaData.meta_workDown()}),this.getTimeOut())}setAddr(t){this.addr=t,PduMetaData.m_addr=t,PduMetaData.meta_workDown()}getUuid(){return this.rpc.rpc_uid()}getAddr(){return this.addr}getTimeOut(){return this.rpc.getTimeOut()}meta_value(t=PduMetaData.m_addr){var s=parseInt(t)+"_100_0_0_0",e=this.rpc.json_rpc_value(s);return null==e&&(s="0_100_0_0_0",e=this.rpc.json_rpc_value(s)),e}meta_Json_value(t,s,e=null){var r=meta_value();return r&&(r=r.get(t).get(s),null!=e&&(r=r.get(e))),r}meta_start(t=PduMetaData.m_addr){this.addr=t,setInterval((function(){PduMetaData.meta_workDown()}),1940+this.getTimeOut())}static meta_workDown(t=PduMetaData.m_addr){var s=[parseInt(t),100,0,0,0];JsonRpc.build().json_rpc_get("pduMetaData",s)}}class PduDataItem extends PduMetaData{getValueByAddr(t,s,e,r,o){var i=t+"_"+s+"_"+e+"_"+r+"_"+o;return this.rpc.json_rpc_value(i)}getValue(t,s,e,r){return this.getValueByAddr(this.addr,t,s,e,r)}getDataByAddr(t,s,e,r,o){var i=[t,s,e,r,o];return this.rpc.json_rpc_get("pduReadData",i)}getData(t,s,e,r){return this.getDataByAddr(this.addr,t,s,e,r)}setDataByAddr(t,s,e,r,o,i){var a=[t,s,e,r,o,i];return this.rpc.json_rpc_set("pduSetData",a)}setData(t,s,e,r,o){return this.setDataByAddr(this.addr,t,s,e,r,o)}}class PduCfgItem extends PduDataItem{constructor(){super()}cfgValue(t,s,e,r){var o=r+"_"+t+"_"+s+"_"+e+"_0";return this.rpc.json_rpc_value(o)}getCfg(t,s,e,r){var o=[r,t,s,e,0];return this.rpc.json_rpc_get("pduReadParam",o)}setCfg(t,s,e,r,o){var i=[o,t,s,r,0,e];return this.rpc.json_rpc_set("pduSetParam",i)}}class PduCfgObj extends PduCfgItem{constructor(){super()}getCfgItems(t,s,e,r=0){for(var o of e)this.getCfg(t,s,o,r)}getCfgIds(t,s,e,r){for(var o=e;o<=r;++o)this.getCfg(t,s,o,0)}getCfgList(t,s,e=0,r=0){for(var o of s)this.getCfg(t,o,e,r)}getCfgFns(t,s,e){for(var r=s;r<=e;++r)this.getCfg(t,r,0,0)}}class PduCfgs extends PduCfgObj{constructor(){super()}loginCfg(){this.getCfg(13,10,0,0),this.getCfg(13,17,0,0),this.getCfg(13,18,0,0),this.getCfg(14,1,0,0),this.getCfg(42,6,0,0),this.getCfg(14,9,0,0)}mqttCfg(){this.getCfgList(19,[1,2,3,4,5,6,7,8,9,10,11])}swVersion(){this.getCfgFns(30,0,8),this.getCfgFns(30,11,15),this.getCfgFns(30,21,23)}dataEncrpty(){this.getCfgList(31,[1,11,12,13,14,15,21,22,23,24,31,32,33,34])}tlscert(){this.getCfgList(32,[1,2,3,4,11,12,13,14,15,16,17,21,22,23,24,25,26,27])}whiteList(){this.getCfgList(33,[1,2,3,4,5,6,7,8,9])}udpPush(){for(let t=1;t<5;t++)this.getCfgIds(18,t,1,4);this.getCfgList(18,[8,9])}httpPush(){this.getCfgList(18,[11,12,13,14,15,16])}rpcCfg(){this.getCfgList(17,[1,2,4,5])}ampqCfg(){this.getCfgList(20,[1,2,3,4,5,6,7,8,9,10,11,12])}snmpCfg(){for(let t=21;t<23;t++)this.getCfgIds(16,t,1,4);this.getCfgList(16,[1,2,3,11,12,13,14,15])}modbusCfg(){this.getCfgList(15,[1,2,3,4,5,6,11,12,13])}odbcCfg(){var t=[1,2,3,4,5,6,7,8,9,10];this.getCfgList(21,t),this.getCfgList(28,t)}OutInGroup(){for(let t=1;t<13;t++)this.getCfg(25,t,0,this.addr)}baseCfg(){for(let t=0;t<8;t++)this.getCfgIds(41,t,0,1);this.getCfgList(41,[10,11])}webCfg(){this.getCfgList(42,[1,2,3,4,5,6,7,8])}ntpCfg(){this.getCfgList(43,[1,2,3,4])}smtpCfg(){this.getCfgList(44,[1,2,3,4,6,7,8]),this.getCfgIds(44,5,1,4)}sshCfg(){this.getCfgList(45,[1,2,3,4])}syslogCfg(){this.getCfgList(46,[1,2,3])}radiusCfg(){this.getCfgList(48,[1,2,3,4,5,6]),this.getCfgList(49,[1,2,3])}diagnosticsCfg(){this.getCfgList(93,[1,2,3,6,7,8])}modesetCfg(){this.getCfgList(13,[3,4,7,8,9,10,21])}placesetCfg(){this.getCfgList(11,[1,2,3,4,5,6,7])}usrinfoCfg(){for(let t=1;t<6;t++)this.getCfgIds(14,t,0,4)}sysinfoCfg(){this.getCfgList(30,[0,1,2,3,4,5,6,7,8,9,11,12,13,14,15,16,21,22,23])}fwupdateCfg(t,s){for(let s=1;s<t+1;s++)this.getCfg(92,6,4,s),this.getCfg(92,6,5,s);for(let t=1;t<s+1;t++)this.getCfg(92,7,4,t),this.getCfg(92,7,5,t)}logseetingCfg(){this.getCfgList(47,[1,2,3,4,5,6])}debugCfg(){let t=[1,1,1,2,2,2,3,6,6,3],s=[2,3,4,2,3,4,3,11,12,4],e=[2,5,6,7,4];this.getCfgList(13,[1,9,10,11,12,13,17,18]);for(let r=0;r<t.length;r++)for(let o of e)this.getData(t[r],s[r],o,0)}debugVolData(t){for(let s=1;s<t+1;s++)this.getData(3,2,1,s)}alotCfg(){this.getCfgList(51,[1,2,3,4,5,6,7])}data_backCfg(){this.getCfgList(29,[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15])}}class PduLog extends PduCfgs{constructor(){super()}log_get(t,s,e,r){var o=e+"_81_"+t+"_"+s+"_"+r;return this.rpc.json_rpc_value(o)}log_fun(t,s,e,r){var o=[e,81,t,s,r];return this.rpc.json_rpc_get("pduLogFun",o)}log_hda(t,s,e,r){var o=[t,82,s,e,r];return this.rpc.json_rpc_get("pduLogHda",o)}log_value(t,s){var e=t+"_82_"+s;return this.rpc.json_rpc_value(e)}}class PduOta extends PduLog{constructor(){super()}otaValue(t,s,e){var r=e+"_92_"+t+"_"+s+"_"+e;return this.rpc.json_rpc_value(r)}getOta(t,s,e){var r=[e,92,t,s,e];return this.rpc.json_rpc_get("pduReadParam",r)}}class PduCore extends PduOta{static _instance=null;constructor(){super()}static build(){return PduCore._instance||(PduCore._instance=new PduCore),PduCore._instance}login_check(){var t=window.sessionStorage,s=t.getItem(btoa("uuid")),e=0;if(null!=s){var r=window.location.host,o=t.getItem(btoa("host"));s.length>9&&r==o&&(e=1)}if(0==e){this.login_out();var i=window.location.protocol+"//";i+=window.location.host,window.location.replace(i)}return e}login_out(){var t=window.sessionStorage,s=btoa(window.location.host);t.setItem(btoa("host")," "),t.setItem(btoa("uuid"),s)}login_permit(){var t=JSON.parse(this.meta_value(0));let s=window.sessionStorage.getItem("username"),e=0;return s&&t&&(e=t.login_permits[s],null==e&&(e=0)),e}clear(){this.rpc.clear()}}
