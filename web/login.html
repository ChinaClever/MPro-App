<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SIGN IN</title>
  <link rel="stylesheet" href="./include/css/style.css">
</head>
<body>
  <div class="outer_box">
    <div class="inner_box">
      <div class="center_form">
      </div>
    </div>
  </div>
  <script src="./include/js/jquery-1.11.3.min.js"></script>
	<script src="./include/js/pdu_rpc.js"></script>
  <script>
    var obj = new PduCfgItem;
		// var pattern = /^.*(?=.{6,16})(?=.*\d)(?=.*[A-Z]{2,})(?=.*[a-z]{2,})(?=.*[!@#$%^&*?\(\)]).*$/;
		let pattern_ = /^[a-zA-Z0-9]{5,16}$/;
		let pattern = /^.*(?=.{6,16})(?=.*\d)(?=.*[A-Z]{1,})(?=.*[a-z]{1,}).*$/;
    let time1_num = 0;
    let time2_num = 0;
    let time3_num = 0;
    let user = 14;
    let web_service = 0;
    let user_name,identify;
    let time1 = setInterval(function(){
      if(time1_num== 20 ){
        clearInterval(time1);
      }
      web_service = obj.cfgValue(42,3,0,0);
      if(web_service != null){
        if(web_service == 1){
          if(window.location.protocol === "http:"){
            window.location.href = window.location.href.replace("http:","https:")
          }
        }
        clearInterval(time1);
      }
      time1_num ++;
    },50);
    function LangInit(){

    }
    language = obj.cfgValue(13,10,0,0);
    document.onkeydown = function(e){
      var keyNum = window.event?e.keyCode:e.which;
      if(keyNum == 13){
        sign_in();
      }
    }
    let time3 = setInterval(function(){
      if(time3_num== 2 ){
        clearInterval(time3);
      }
      user_name = obj.cfgValue(user,1,0,0);
      identify = obj.cfgValue(user,3,0,0);
      if(user_name == null ||  user_name == ""){
          GotoRegisterPage();
          clearInterval(time3);
      }else{
         $('.center_form').html(BuildDiv('signin'));
         clearInterval(time3);
      }
      document.getElementById('username').value = '';
      document.getElementById('psd').value ='';
      time1_num ++;
    },500);
    function sign_in(){
      let usr = document.getElementById('username').value;
      let psd = document.getElementById('psd').value;
      if(usr != "" && psd !=""){
        if(!pattern_.test(usr))
        {
          alert("请输入5-16位用户名");
          return ;
        }
        if(!pattern.test(psd)){
          alert("请输入6-16位密码,密码必须包含至少一个数字,大写和小写字母");
          return ;
        }
        let userPsd = usr + ";" + psd;
        obj.setCfg(user,11,userPsd,0,0);
        let time2 = setInterval(function(){
          if(time2_num== 10){
            clearInterval(time2);
          }
          let ver = obj.cfgValue(user,11,0,0);
          if(ver === null || ver === ""){
          }else{
            if(ver  === "1"){
              var key = '0_14_11_0_0';
              obj.rpc.root_map.set(key, "");
              window.open('index.html','_self');
            }else if(ver == "0"){
              alert("用户名或密码输入有误，请重新输入！");
            }else{
              let num = ver.abs();
              alert("密码验证次数过多，账号已锁定，请于" + num +"分钟后再试！");
            }
            window.clearInterval(time2);
          }
          time2_num ++;
        },100);
      }else{
        alert("请输入用户名和密码后登陆");
      }    
    }
    function submite(){
      var div= document.getElementsByClassName('center_form');
      for(var i = 0; i<div[0].childElementCount;i++){
        div[0].removeChild(div[0].childNodes[i]);
      }
      $('.center_form').html(BuildDiv('submite'));
    }
    function GotoRegisterPage(){
      var div= document.getElementsByClassName('center_form');
      for(var i = 0; i<div[0].childElementCount;i++){
        div[0].removeChild(div[0].childNodes[i]);
      }
      $('.center_form').html(BuildDiv('register'));
    }
    function submite1(){
      let usr = document.getElementById('username').value;
      let psd = document.getElementById('psd').value;
      let conpsd = document.getElementById('conpsd').value;
      let ident = document.getElementById('ident').value;
      if(user =='' || psd == '' || conpsd == ''||ident == '' || psd != conpsd||usr != user_name || ident != identify){
        alert("输入有误请重新输入！");
      }
      else{
        if(!pattern.test(psd)){
          alert("请输入6-16位密码,密码必须包含至少一个数字,大写和小写字母");
          return ;
        }
        obj.setCfg(user,2,psd,0,0);
        setTimeout(function(){
          var div= document.getElementsByClassName('center_form');
          for(var i = 0; i<div[0].childElementCount;i++){
            div[0].removeChild(div[0].childNodes[i]);
          }
          $('.center_form').html(BuildDiv('signin'));
        },800);
      }
    }
    function register1(){
      let usr = document.getElementById('username').value;
      let psd = document.getElementById('psd').value;
      let conpsd = document.getElementById('conpsd').value;
      let ient = document.getElementById('ident').value;
      if(user =='' || psd == '' || conpsd == ''||ient == '' || psd != conpsd){
        alert("输入有误请重新输入！");
      }
      else{
        if(!pattern_.test(usr))
        {
          alert("请输入5-16位用户名");
          return ;
        }
        if(!pattern.test(psd)){
          alert("请输入6-16位密码,密码必须包含至少一个数字,大写和小写字母");
          return ;
        }
        if(!pattern.test(ient)){
          alert("请输入6-16位验证信息,验证信息必须包含至少一个数字,大写和小写字母");
          return ;
        }
        obj.setCfg(user,1,usr,0,0);
        obj.setCfg(user,2,psd,0,0);
        obj.setCfg(user,3,ient,0,0);
        setTimeout(function(){
          var div= document.getElementsByClassName('center_form');
          for(var i = 0; i<div[0].childElementCount;i++){
            div[0].removeChild(div[0].childNodes[i]);
          }
          $('.center_form').html(BuildDiv('signin'));
        },800);
      }
    }
    function printError(elemId, hintMsg)
    {
      document.getElementById(elemId).innerHTML = hintMsg;
    }
    function check(){
      let usr = document.getElementById('username').value;
      var psd_val = document.getElementById("psd").value;
      if(usr != "" && psd_val !=""){
        // document.getElementById("sign_in").removeAttribute('disabled');
        document.getElementById("sign_in").style.backgroundColor ="#8AA";
      }else{
        // document.getElementById("sign_in").setAttribute('disabled','');
        document.getElementById("sign_in").style.backgroundColor ="#9CC";
      }
    }
    function ClickEvent(){
      document.getElementById("sign_in").style.color = "red";
      setTimeout(function(){document.getElementById("sign_in").style.color = "#FFF"},1000);
    }
    setTimeout(function(){
      document.getElementById("sign_in").onmouseover = function () {
        document.getElementById("sign_in").style.border = "2px outset #E8E8E8";
      }
      document.getElementById("sign_in").onmouseout = function () {
        document.getElementById("sign_in").style.border = "";
      }
    },1200);
    function validataForm(ipt)
    {
      var con = document.getElementById("conpsd");
      var code = document.getElementById("ident");
      var psd_val = document.getElementById("psd");
      if(code != null && con != null)
      {
        if(ipt.value == "" && ipt.id == "username"){
          printError("Errinfo", "用户名不能为空");
        }else if(ipt.value == "" && ipt.id == "psd"){
          printError("Errinfo", "密码不能为空");
        }else if((ipt.value == "" || ipt.value !== psd_val.value)&& ipt.id == "conpsd"){
          printError("Errinfo", "两次密码不一致，请重新输入");
        }else if(ipt.value == "" && ipt.id == "ident"){
          printError("Errinfo", "身份验证信息不能为空");
        }else{
          printError("Errinfo", "");
        }
      }
      else if(con == null && code == null)
      {
        if(ipt.value == "" && ipt.id == "username"){
          printError("Errinfo", "用户名不能为空");
        }else if(ipt.value == "" && ipt.id == "psd"){
          printError("Errinfo", "密码不能为空");
        }
        else{
          printError("Errinfo", "");
        }
      }
      else{
        if(ipt.value == "" && ipt.id == "username"){
          printError("Errinfo", "用户名不能为空");
        }else if(ipt.value == "" && ipt.id == "ident"){
          printError("Errinfo", "请输入正确的验证信息");
        }else{
          printError("Errinfo", "");
        }
      }
    }
    function Clear(obj){
      obj.value = obj.value.replace(/[^\w_]/g,"");
    }
    function BuildDiv(Reg){
      var tbody = '';
      if(Reg === 'register')
      {
        tbody += '<p class="title"><span>注册页</span></p><span class="error" id = "Errinfo"></span>';
        tbody += '<p><input id ="username" type="username" maxlength="20"; onkeyup = "Clear(this)" placeholder="用户名" onblur = "validataForm(this)">';
        tbody += '<p><input id ="psd" type="text" onfocus = \'this.type="password"\'  maxlength="20"; onblur = "validataForm(this)" placeholder="密码"></p>';
        tbody += '<p><input id ="conpsd" type="text" onfocus = \'this.type="password"\'  maxlength="20"; onblur = "validataForm(this)" placeholder="确认密码"></p>';
        tbody += '<p><input id ="ident" type="text" maxlength="20"; autocomplete="off" onblur = "validataForm(this)"  placeholder="设置验证信息"></p>';
        tbody += '<p class = "signIn_btn"><input id = "sign_in" type = "button"  value = "注册" onclick="register1()"></input></p>';
      }else if(Reg==='signin') {
        tbody += '<br/><p class="title"><span>登陆页</span></p><span class="error" id = "Errinfo"></span>';
        tbody += '<p><input id ="username" type="text" maxlength="20" placeholder="用户名" onkeyup = "Clear(this)" onblur = "validataForm(this)" oninput ="check();" autocomplete="off"></p>';
        tbody += '<p><input id ="psd" type="text" onfocus = \'this.type="password"\' maxlength="20" autocomplete="off" oninput ="check();" onblur = "validataForm(this)"  placeholder="密码"></p>';
        tbody += '<div class="chk"><span></span><span><a href ="javascript:submite();">重置密码</a></span></div><p></p>';
        tbody += '<p class = "signIn_btn"><input id = "sign_in" type = "button" value = "登陆" onclick="sign_in()"></input></p>';
      }else if(Reg === 'submite'){
        tbody += '<p class="title"><span>重置密码</span></p><p class="error" id = "Errinfo"></p>';
        tbody += '<p><input id ="username" type="text" maxlength="20" onblur= "validataForm(this)" onkeyup = "Clear(this)" placeholder="用户名"></p>';
        tbody += '<p><input id ="psd" type="text" onfocus = \'this.type="password"\'  maxlength="20"; onblur = "validataForm(this)" placeholder="新密码"></p>';
        tbody += '<p><input id ="conpsd" type="text" onfocus = \'this.type="password"\'  maxlength="20"; onblur = "validataForm(this)" placeholder="确认密码"></p>';
        tbody += '<p><input id ="ident" type="text" maxlength="20" onblur = "validataForm(this)" autocomplete="off"  placeholder="Identifying code"></p>';
        tbody += '<p class = "signIn_btn"><input id = "sign_in" type = "button" value = "提交" onclick="submite1()"></input></p>';
      }
      return tbody;
    }
  </script>

</body>
</html>
