<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SIGN IN</title>
  <link rel="stylesheet" href="./include/css/style.css">
</head>
<body>
  <div class="outer_box">
    <div class="inner_box">
      <div class="center_form">
      </div>
    </div>
  </div>
  <script src="./include/js/jquery-1.11.3.min.js"></script>
  <script src="./include/js/fn_public.js"></script>
	<script src="./include/js/rpc-over-websocket.js"></script>
  <script>
    let time_1_num = 0;
    let time_1 = setInterval(function(){
      if(time_1_num== 10 ){
        clearInterval(time_1);
      }
      if(sessionStorage.getItem(web_service[3]) != null){
        if(parseInt(sessionStorage.getItem(web_service[3])) == 1){
          if(window.location.protocol === "http:"){
            window.location.href = window.location.href.replace("http:","https:")
          }
        }
        clearInterval(time_1);
      }
      time_1_num ++;
    },100);
      
    language = parseInt(sessionStorage.getItem("LanguageEn" + addr));
    document.onkeydown = function(e){
      var keyNum = window.event?e.keyCode:e.which;
      if(keyNum == 13){
        sign_in();
      }
    }
    $('.center_form').html(builddiv('signin'));
    console.log("1");
    var time = setTimeout(function (){
      console.log("2");
      user_name = sessionStorage.getItem(user_info[1] + 0);
      password = sessionStorage.getItem(user_info[2] + 0);
      identify = sessionStorage.getItem(user_info[3] + 0);
      if(user_name == '' && password ==''){
        register();
        }
      document.getElementById('username').value = '';
      document.getElementById('psd').value ='';
    },1000);
    function sign_in(){
      let usr = document.getElementById('username').value;
      let psd = document.getElementById('psd').value;
      if(usr != "" && psd !=""){
        let userPsd = usr + "; " + psd;
        rpc.call('pduSetParam',[0,user,11,0,0,userPsd]);
        let time2 = setInterval(function(){
          if(verfity == 1)
          {
            verfity = 0;
            let ver = parseInt(sessionStorage.getItem(user_info[11] + 0));
            if(ver  == 1){
              sessionStorage.setItem(user_info[11],0);
              window.open('index.html','_self');
            }else{
              alert("用户名或密码输入有误，请重新输入！");
            }
            window.clearInterval(time2);
          }
        },500);
      }else{
        alert("user name or password error");
      }    
    }
    function submite(){
      var div= document.getElementsByClassName('center_form');
      for(var i = 0; i<div[0].childElementCount;i++){
        div[0].removeChild(div[0].childNodes[i]);
      }
      $('.center_form').html(builddiv('submite'));
    }
    function register(){
      var div= document.getElementsByClassName('center_form');
      for(var i = 0; i<div[0].childElementCount;i++){
        div[0].removeChild(div[0].childNodes[i]);
      }
      $('.center_form').html(builddiv('register'));
    }
    function submite1(){
      let usr = document.getElementById('username').value;
      let psd = document.getElementById('psd').value;
      let conpsd = document.getElementById('conpsd').value;
      let ident = document.getElementById('ident').value;
      if(user =='' || psd == '' || conpsd == ''||ident == '' || psd != conpsd||usr != user_name || ident != identify){
        alert("输入有误请重新输入！");
      }
      else{
        rpc.call('pduSetParam',[0,user,2,0,0,psd]);
        setTimeout(function(){
          read_user_info();
          var div= document.getElementsByClassName('center_form');
          for(var i = 0; i<div[0].childElementCount;i++){
            div[0].removeChild(div[0].childNodes[i]);
          }
          $('.center_form').html(builddiv('signin'));
        },800);
      }
    }
    function register1(){
      let usr = document.getElementById('username').value;
      let psd = document.getElementById('psd').value;
      let conpsd = document.getElementById('conpsd').value;
      let ient = document.getElementById('ident').value;
      if(user =='' || psd == '' || conpsd == ''||ient == '' || psd != conpsd){
        alert("输入有误请重新输入！");
      }
      else{
        rpc.call('pduSetParam',[0,user,1,0,0,usr]);
        rpc.call('pduSetParam',[0,user,2,0,0,psd]);
        rpc.call('pduSetParam',[0,user,3,0,0,ient]);
        setTimeout(function(){
          read_user_info();
          var div= document.getElementsByClassName('center_form');
          for(var i = 0; i<div[0].childElementCount;i++){
            div[0].removeChild(div[0].childNodes[i]);
          }
          $('.center_form').html(builddiv('signin'));
        },800);
      }
    }
    function printError(elemId, hintMsg)
    {
      document.getElementById(elemId).innerHTML = hintMsg;
    }
    function check(){
      let usr = document.getElementById('username').value;
      var psd_val = document.getElementById("psd").value;
      if(usr != "" && psd_val !=""){
        document.getElementById("sign_in").removeAttribute('disabled');
        document.getElementById("sign_in").style.backgroundColor ="#8AA";
      }else{
        document.getElementById("sign_in").setAttribute('disabled','');
        document.getElementById("sign_in").style.backgroundColor ="#9CC";
      }
    }
    function validataForm(ipt)
    {
      var con = document.getElementById("conpsd");
      var code = document.getElementById("ident");
      var psd_val = document.getElementById("psd");
      if(code != null && con != null)
      {
        if(ipt.value == "" && ipt.id == "username"){
          printError("Errinfo", "用户名不能为空");
        }else if(ipt.value == "" && ipt.id == "psd"){
          printError("Errinfo", "密码不能为空");
        }else if((ipt.value == "" || ipt.value !== psd_val.value)&& ipt.id == "conpsd"){
          printError("Errinfo", "两次密码不一致，请重新输入");
        }else if(ipt.value == "" && ipt.id == "ident"){
          printError("Errinfo", "身份验证信息不能为空");
        }else{
          printError("Errinfo", "");
        }
      }
      else if(con == null && code == null)
      {
        if(ipt.value == "" && ipt.id == "username"){
          printError("Errinfo", "用户名不能为空");
        }else if(ipt.value == "" && ipt.id == "psd"){
          printError("Errinfo", "密码不能为空");
        }
        else{
          printError("Errinfo", "");
        }
      }
      else{
        if(ipt.value == "" && ipt.id == "username"){
          printError("Errinfo", "用户名不能为空");
        }else if(ipt.value == "" && ipt.id == "ident"){
          printError("Errinfo", "请输入正确的验证信息");
        }else{
          printError("Errinfo", "");
        }
      }
    }
    var time1 = setTimeout(function(){
      ReadHomeData();
      // read_dev_name();
			read_ver_info(default_addr);
			// read_phase_data(addr);
    },500);
    function builddiv(Reg){
      var tbody = '';
      if(Reg === 'register')
      {
        tbody += '<p class="title"><span>注册页</span></p><span class="error" id = "Errinfo"></span>';
        tbody += '<p><input id ="username" type="username" maxlength="20"; placeholder="用户名" onblur = "validataForm(this)">';
        tbody += '<p><input id ="psd" type="text" onfocus = \'this.type="password"\'  maxlength="20"; onblur = "validataForm(this)" placeholder="密码"></p>';
        tbody += '<p><input id ="conpsd" type="text" onfocus = \'this.type="password"\'  maxlength="20"; onblur = "validataForm(this)" placeholder="确认密码"></p>';
        tbody += '<p><input id ="ident" type="text" maxlength="20"; autocomplete="off" onblur = "validataForm(this)"  placeholder="设置验证信息"></p>';
        tbody += '<p class = "signIn_btn"><input type = "button"  value = "注册" onclick="register1()"></input></p>';
      }else if(Reg==='signin') {
        tbody += '<br/><p class="title"><span>登陆页</span></p><span class="error" id = "Errinfo"></span>';
        tbody += '<p><input id ="username" type="text" maxlength="20" placeholder="用户名" onblur = "validataForm(this)" oninput ="check();" autocomplete="off"></p>';
        tbody += '<p><input id ="psd" type="text" onfocus = \'this.type="password"\' maxlength="20" autocomplete="off" oninput ="check();" onblur = "validataForm(this)"  placeholder="密码"></p>';
        tbody += '<div class="chk"><span></span><span><a href ="javascript:submite();">重置密码</a></span></div><p></p>';
        tbody += '<p class = "signIn_btn"><input id = "sign_in" type = "button" disabled="" value = "登陆" onclick="sign_in()"></input></p>';
      }else if(Reg === 'submite'){
        tbody += '<p class="title"><span>重置密码</span></p><p class="error" id = "Errinfo"></p>';
        tbody += '<p><input id ="username" type="text" maxlength="20" onblur= "validataForm(this)" placeholder="用户名"></p>';
        tbody += '<p><input id ="psd" type="text" onfocus = \'this.type="password"\'  maxlength="20"; onblur = "validataForm(this)" placeholder="新密码"></p>';
        tbody += '<p><input id ="conpsd" type="text" onfocus = \'this.type="password"\'  maxlength="20"; onblur = "validataForm(this)" placeholder="确认密码"></p>';
        tbody += '<p><input id ="ident" type="text" maxlength="20" onblur = "validataForm(this)" autocomplete="off"  placeholder="Identifying code"></p>';
        tbody += '<p class = "signIn_btn"><input type = "button" value = "提交" onclick="submite1()"></input></p>';
      }
      return tbody;
    }
  </script>

</body>
</html>
